# ===============================================
# PR CHECKS - Verificaciones de Pull Request
# Master en IngenierÃ­a de Datos
# ===============================================
# Se ejecuta en:
# - Pull Requests a dev o main
# ===============================================

name: âœ… PR Checks

on:
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ===============================================
  # JOB 1: VALIDACIÃ“N DE PR
  # ===============================================
  pr-validation:
    name: ğŸ“‹ ValidaciÃ³n de PR
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Verificar tÃ­tulo del PR
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            El tÃ­tulo debe empezar con mayÃºscula.
            Formato: tipo: DescripciÃ³n
            Ejemplo: feat: AÃ±adir nueva funcionalidad

      - name: ğŸ“ Verificar descripciÃ³n del PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr.body || pr.body.length < 20) {
              core.setFailed('âŒ El PR debe tener una descripciÃ³n de al menos 20 caracteres');
            } else {
              core.info('âœ… DescripciÃ³n del PR vÃ¡lida');
            }

      - name: ğŸ” Verificar archivos modificados
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const largeFiles = files.filter(f => f.changes > 500);
            if (largeFiles.length > 0) {
              core.warning('âš ï¸ Archivos con mÃ¡s de 500 cambios: ' +
                largeFiles.map(f => f.filename).join(', '));
            }

            const totalChanges = files.reduce((sum, f) => sum + f.changes, 0);
            core.info(`ğŸ“Š Total de cambios: ${totalChanges}`);

  # ===============================================
  # JOB 2: ANÃLISIS DE CAMBIOS
  # ===============================================
  changes-analysis:
    name: ğŸ“Š AnÃ¡lisis de Cambios
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detectar archivos modificados
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            python:
              - '**/*.py'
            tests:
              - 'tests/**'
            docs:
              - 'documentacion/**'
              - '**/*.md'
            config:
              - '**/*.yml'
              - '**/*.yaml'
              - '**/*.toml'
              - '**/*.json'
            docker:
              - 'docker-compose.yml'
              - 'Dockerfile'
            airflow:
              - 'airflow/**'

      - name: ğŸ“ Comentar cambios detectados
        uses: actions/github-script@v7
        with:
          script: |
            const changes = ${{ toJSON(steps.changes.outputs) }};
            let comment = '## ğŸ“Š AnÃ¡lisis de Cambios\n\n';

            if (changes.python === 'true') comment += 'ğŸ CÃ³digo Python modificado\n';
            if (changes.tests === 'true') comment += 'ğŸ§ª Tests modificados\n';
            if (changes.docs === 'true') comment += 'ğŸ“š DocumentaciÃ³n modificada\n';
            if (changes.config === 'true') comment += 'âš™ï¸ ConfiguraciÃ³n modificada\n';
            if (changes.docker === 'true') comment += 'ğŸ³ Docker modificado\n';
            if (changes.airflow === 'true') comment += 'ğŸŒŠ Airflow modificado\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ===============================================
  # JOB 3: VERIFICACIÃ“N DE TESTS
  # ===============================================
  test-coverage:
    name: ğŸ§ª Cobertura de Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r requirements.txt

      - name: ğŸ§ª Ejecutar tests con cobertura
        run: |
          pytest tests/ --cov=. --cov-report=term-missing --cov-report=json

      - name: ğŸ“Š Comentar cobertura en PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
              const percent = coverage.totals.percent_covered.toFixed(2);

              let emoji = 'âœ…';
              if (percent < 80) emoji = 'âš ï¸';
              if (percent < 60) emoji = 'âŒ';

              const comment = `## ${emoji} Cobertura de Tests: ${percent}%\n\n` +
                `- LÃ­neas cubiertas: ${coverage.totals.covered_lines}\n` +
                `- LÃ­neas totales: ${coverage.totals.num_statements}\n` +
                `- LÃ­neas faltantes: ${coverage.totals.missing_lines}`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              core.info('No se pudo leer el reporte de cobertura');
            }

  # ===============================================
  # JOB 4: VERIFICACIÃ“N DE SEGURIDAD
  # ===============================================
  security-check:
    name: ğŸ”’ VerificaciÃ³n de Seguridad
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]
          pip install -r requirements.txt

      - name: ğŸ”’ Ejecutar Bandit
        run: |
          bandit -r . -c pyproject.toml -f json -o bandit-report.json || true

      - name: ğŸ“Š Comentar resultados de seguridad
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
              const high = report.metrics._totals['SEVERITY.HIGH'] || 0;
              const medium = report.metrics._totals['SEVERITY.MEDIUM'] || 0;
              const low = report.metrics._totals['SEVERITY.LOW'] || 0;

              let emoji = 'âœ…';
              if (high > 0) emoji = 'âŒ';
              else if (medium > 0) emoji = 'âš ï¸';

              const comment = `## ${emoji} AnÃ¡lisis de Seguridad (Bandit)\n\n` +
                `- ğŸ”´ Alta: ${high}\n` +
                `- ğŸŸ¡ Media: ${medium}\n` +
                `- ğŸŸ¢ Baja: ${low}`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              core.info('No se pudo leer el reporte de seguridad');
            }
