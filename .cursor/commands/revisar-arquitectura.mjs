#!/usr/bin/env node

/**
 * Comando para revisar la arquitectura del proyecto
 * Detecta archivos mal ubicados, estructura desorganizada y sugiere mejoras
 */

import { readdir, stat } from 'fs/promises';
import { join } from 'path';

// Configuraci√≥n de la estructura esperada
const ESTRUCTURA_ESPERADA = {
    raiz: {
        permitidos: [
            'README.md',
            'requirements.txt',
            'docker-compose.yml',
            '.gitignore',
            '.env',
            'pyproject.toml',
            'setup.py',
            'LICENSE'
        ],
        carpetas_obligatorias: [
            'documentacion',
            'src',
            'tests',
            'scripts'
        ]
    },
    documentacion: {
        descripcion: 'Toda la documentaci√≥n del proyecto',
        patrones: [
            'CHANGELOG.md',
            'GUIA_*.md',
            'PROGRAMA_*.md',
            'PROYECTOS_*.md',
            'RECURSOS.md',
            'RESUMEN_*.md',
            'ENV_EXAMPLE.md',
            '*_JAR-*.md',  // Tickets de Jira
            'REPORTE_*.md',
            'CHECKLIST_*.md',
            'INSTRUCCIONES_*.md',
            'PR_*.md',
            'COMMIT_MESSAGE_*.md',
            '*.pdf'
        ]
    },
    scripts: {
        descripcion: 'Scripts de automatizaci√≥n y setup',
        patrones: ['*.sh', '*.ps1', '*.bat']
    },
    temporal: {
        descripcion: 'Archivos que deber√≠an eliminarse o moverse',
        patrones: [
            'claude.md',
            'game_save.json',
            'game.html',
            '*_JUEGO*.md'
        ]
    }
};

const COLORES = {
    reset: '\x1b[0m',
    rojo: '\x1b[31m',
    verde: '\x1b[32m',
    amarillo: '\x1b[33m',
    azul: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m',
    bold: '\x1b[1m'
};

class RevisorArquitectura {
    constructor() {
        this.problemas = [];
        this.advertencias = [];
        this.sugerencias = [];
        this.archivos_raiz = [];
    }

    log(mensaje, color = '') {
        console.log(`${color}${mensaje}${COLORES.reset}`);
    }

    async obtenerArchivosRaiz() {
        try {
            const items = await readdir('.');
            const archivos = [];

            for (const item of items) {
                const stats = await stat(item);
                if (stats.isFile()) {
                    archivos.push(item);
                }
            }

            return archivos;
        } catch (error) {
            this.problemas.push(`Error al leer directorio ra√≠z: ${error.message}`);
            return [];
        }
    }

    coincidePatron(archivo, patron) {
        const regex = new RegExp('^' + patron.replace(/\*/g, '.*') + '$');
        return regex.test(archivo);
    }

    clasificarArchivo(archivo) {
        // Verificar si est√° permitido en ra√≠z
        if (ESTRUCTURA_ESPERADA.raiz.permitidos.includes(archivo)) {
            return 'permitido';
        }

        // Verificar si deber√≠a estar en documentacion
        for (const patron of ESTRUCTURA_ESPERADA.documentacion.patrones) {
            if (this.coincidePatron(archivo, patron)) {
                return 'documentacion';
            }
        }

        // Verificar si es temporal
        for (const patron of ESTRUCTURA_ESPERADA.temporal.patrones) {
            if (this.coincidePatron(archivo, patron)) {
                return 'temporal';
            }
        }

        // Verificar si es script
        for (const patron of ESTRUCTURA_ESPERADA.scripts.patrones) {
            if (this.coincidePatron(archivo, patron)) {
                return 'scripts';
            }
        }

        return 'desconocido';
    }

    async analizar() {
        this.log('\n' + '='.repeat(80), COLORES.bold + COLORES.cyan);
        this.log('üìã REVISOR DE ARQUITECTURA DEL PROYECTO', COLORES.bold + COLORES.cyan);
        this.log('='.repeat(80) + '\n', COLORES.bold + COLORES.cyan);

        // Obtener archivos en ra√≠z
        this.archivos_raiz = await this.obtenerArchivosRaiz();

        // Clasificar archivos
        const clasificacion = {
            permitido: [],
            documentacion: [],
            scripts: [],
            temporal: [],
            desconocido: []
        };

        for (const archivo of this.archivos_raiz) {
            const tipo = this.clasificarArchivo(archivo);
            clasificacion[tipo].push(archivo);
        }

        // Reportar problemas
        this.reportarProblemas(clasificacion);
        this.reportarAdvertencias(clasificacion);
        this.generarSugerencias(clasificacion);
        this.mostrarResumen();
        this.mostrarEstructuraRecomendada();
    }

    reportarProblemas(clasificacion) {
        if (clasificacion.documentacion.length > 0) {
            this.log('\nüî¥ PROBLEMAS CR√çTICOS:', COLORES.bold + COLORES.rojo);
            this.log('‚îÄ'.repeat(80), COLORES.rojo);
            this.log('\nArchivos de documentaci√≥n en ra√≠z que deber√≠an estar en documentacion/:\n', COLORES.rojo);

            clasificacion.documentacion.forEach(archivo => {
                this.log(`  ‚Ä¢ ${archivo}`, COLORES.rojo);
                this.problemas.push(`${archivo} deber√≠a estar en documentacion/`);
            });
        }

        if (clasificacion.scripts.length > 0) {
            if (this.problemas.length === 0) {
                this.log('\nüî¥ PROBLEMAS CR√çTICOS:', COLORES.bold + COLORES.rojo);
                this.log('‚îÄ'.repeat(80), COLORES.rojo);
            }
            this.log('\nScripts en ra√≠z que deber√≠an estar en scripts/:\n', COLORES.rojo);

            clasificacion.scripts.forEach(archivo => {
                this.log(`  ‚Ä¢ ${archivo}`, COLORES.rojo);
                this.problemas.push(`${archivo} deber√≠a estar en scripts/`);
            });
        }
    }

    reportarAdvertencias(clasificacion) {
        if (clasificacion.temporal.length > 0) {
            this.log('\n‚ö†Ô∏è  ADVERTENCIAS:', COLORES.bold + COLORES.amarillo);
            this.log('‚îÄ'.repeat(80), COLORES.amarillo);
            this.log('\nArchivos temporales o de desarrollo que deber√≠an revisarse:\n', COLORES.amarillo);

            clasificacion.temporal.forEach(archivo => {
                this.log(`  ‚Ä¢ ${archivo} - Considerar eliminar o mover`, COLORES.amarillo);
                this.advertencias.push(`${archivo} parece ser temporal`);
            });
        }

        if (clasificacion.desconocido.length > 0) {
            if (this.advertencias.length === 0) {
                this.log('\n‚ö†Ô∏è  ADVERTENCIAS:', COLORES.bold + COLORES.amarillo);
                this.log('‚îÄ'.repeat(80), COLORES.amarillo);
            }
            this.log('\nArchivos no clasificados (revisar si pertenecen en ra√≠z):\n', COLORES.amarillo);

            clasificacion.desconocido.forEach(archivo => {
                this.log(`  ‚Ä¢ ${archivo}`, COLORES.amarillo);
                this.advertencias.push(`${archivo} no est√° clasificado`);
            });
        }
    }

    generarSugerencias(clasificacion) {
        this.log('\nüí° SUGERENCIAS DE MEJORA:', COLORES.bold + COLORES.azul);
        this.log('‚îÄ'.repeat(80), COLORES.azul);

        if (clasificacion.documentacion.length > 0) {
            this.log('\n1. Mover archivos de documentaci√≥n:', COLORES.azul);
            clasificacion.documentacion.forEach(archivo => {
                this.log(`   mv "${archivo}" documentacion/`, COLORES.cyan);
            });
            this.sugerencias.push('Organizar documentaci√≥n en carpeta dedicada');
        }

        if (clasificacion.scripts.length > 0) {
            this.log('\n2. Mover scripts a su carpeta:', COLORES.azul);
            clasificacion.scripts.forEach(archivo => {
                this.log(`   mv "${archivo}" scripts/`, COLORES.cyan);
            });
            this.sugerencias.push('Organizar scripts en carpeta dedicada');
        }

        if (clasificacion.temporal.length > 0) {
            this.log('\n3. Limpiar archivos temporales:', COLORES.azul);
            clasificacion.temporal.forEach(archivo => {
                this.log(`   # Revisar si es necesario: ${archivo}`, COLORES.cyan);
            });
            this.sugerencias.push('Limpiar archivos temporales no necesarios');
        }

        // Sugerencias adicionales
        this.log('\n4. Sugerencias adicionales de arquitectura:', COLORES.azul);
        this.log('   ‚Ä¢ Crear .cursorignore para excluir archivos temporales', COLORES.cyan);
        this.log('   ‚Ä¢ Actualizar .gitignore con archivos de trabajo temporal', COLORES.cyan);
        this.log('   ‚Ä¢ Considerar crear documentacion/jira/ para tickets', COLORES.cyan);
        this.log('   ‚Ä¢ Crear documentacion/reportes/ para reportes de calidad', COLORES.cyan);
    }

    mostrarResumen() {
        this.log('\nüìä RESUMEN:', COLORES.bold + COLORES.magenta);
        this.log('‚îÄ'.repeat(80), COLORES.magenta);

        const total_problemas = this.problemas.length;
        const total_advertencias = this.advertencias.length;
        const total_sugerencias = this.sugerencias.length;

        this.log(`\n  Problemas cr√≠ticos: ${total_problemas}`,
            total_problemas > 0 ? COLORES.rojo : COLORES.verde);
        this.log(`  Advertencias: ${total_advertencias}`,
            total_advertencias > 0 ? COLORES.amarillo : COLORES.verde);
        this.log(`  Sugerencias: ${total_sugerencias}`, COLORES.azul);

        if (total_problemas === 0 && total_advertencias === 0) {
            this.log('\n‚úÖ ¬°La arquitectura del proyecto est√° limpia!', COLORES.bold + COLORES.verde);
        } else {
            this.log('\n‚ö° Se recomienda atender los problemas identificados', COLORES.bold + COLORES.amarillo);
        }
    }

    mostrarEstructuraRecomendada() {
        this.log('\nüìÅ ESTRUCTURA RECOMENDADA:', COLORES.bold + COLORES.verde);
        this.log('‚îÄ'.repeat(80), COLORES.verde);
        this.log(`
proyecto/
‚îú‚îÄ‚îÄ README.md                    # Documentaci√≥n principal
‚îú‚îÄ‚îÄ requirements.txt             # Dependencias Python
‚îú‚îÄ‚îÄ docker-compose.yml          # Configuraci√≥n Docker
‚îú‚îÄ‚îÄ .gitignore                  # Archivos ignorados por git
‚îú‚îÄ‚îÄ .cursorignore              # Archivos ignorados por Cursor
‚îÇ
‚îú‚îÄ‚îÄ documentacion/              # üìö Toda la documentaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ CHANGELOG.md
‚îÇ   ‚îú‚îÄ‚îÄ jira/                   # Tickets y tareas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JAR-200.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ reportes/              # Reportes de calidad
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ REPORTE_CALIDAD.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ guias/                 # Gu√≠as y tutoriales
‚îÇ       ‚îú‚îÄ‚îÄ GUIA_INSTALACION.md
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ src/                       # üîß C√≥digo fuente
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ tests/                     # ‚úÖ Tests
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ scripts/                   # üöÄ Scripts de automatizaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ setup_windows.ps1
‚îÇ   ‚îú‚îÄ‚îÄ setup_linux.sh
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ airflow/                   # Configuraci√≥n Airflow
‚îÇ   ‚îú‚îÄ‚îÄ dags/
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îî‚îÄ‚îÄ plugins/
‚îÇ
‚îî‚îÄ‚îÄ data/                      # üíæ Datos (si aplica)
    ‚îú‚îÄ‚îÄ raw/
    ‚îú‚îÄ‚îÄ processed/
    ‚îî‚îÄ‚îÄ ...
`, COLORES.verde);

        this.log('\nüí° Principios de organizaci√≥n:', COLORES.bold + COLORES.cyan);
        this.log('  1. Ra√≠z limpia: solo archivos esenciales de configuraci√≥n', COLORES.cyan);
        this.log('  2. Documentaci√≥n agrupada: f√°cil de encontrar y mantener', COLORES.cyan);
        this.log('  3. C√≥digo separado: src/ para c√≥digo, tests/ para pruebas', COLORES.cyan);
        this.log('  4. Scripts organizados: herramientas en un solo lugar', COLORES.cyan);
        this.log('  5. Sin archivos temporales: mantener limpio el repositorio', COLORES.cyan);
    }
}

// Ejecutar el revisor
const revisor = new RevisorArquitectura();
revisor.analizar().catch(error => {
    console.error(`${COLORES.rojo}Error fatal: ${error.message}${COLORES.reset}`);
    process.exit(1);
});

